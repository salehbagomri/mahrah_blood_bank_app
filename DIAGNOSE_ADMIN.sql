-- ============================================
-- ุชุดุฎูุต ูุดููุฉ ุตูุงุญูุงุช ุงูุฃุฏูู
-- ูููุฐ ูุฐุง ุงูุณูุฑูุจุช ุฃุซูุงุก ุชุณุฌูู ุฏุฎููู ูุฃุฏูู ูู ุงูุชุทุจูู
-- ============================================

-- 1๏ธโฃ ูุง ูู ูุนุฑู ุงููุณุชุฎุฏู ุงูุญุงููุ
SELECT 
    '1๏ธโฃ ูุนุฑูู ุงูุญุงูู' as "ุงูุงุฎุชุจุงุฑ",
    auth.uid() as "ุงููุชูุฌุฉ",
    CASE 
        WHEN auth.uid() IS NULL THEN 'โ ุบูุฑ ูุณุฌู ุฏุฎูู!'
        ELSE 'โ ูุณุฌู ุฏุฎูู'
    END as "ุงูุญุงูุฉ";

-- ============================================

-- 2๏ธโฃ ูู ุฃูุช ููุฌูุฏ ูู ุฌุฏูู adminsุ
SELECT 
    '2๏ธโฃ ูู ุฃูุช ูู ุฌุฏูู adminsุ' as "ุงูุงุฎุชุจุงุฑ",
    CASE 
        WHEN EXISTS (SELECT 1 FROM public.admins WHERE id = auth.uid()) 
        THEN 'โ ูุนูุ ููุฌูุฏ'
        ELSE 'โ ูุงุ ุบูุฑ ููุฌูุฏ!'
    END as "ุงููุชูุฌุฉ",
    (SELECT email FROM public.admins WHERE id = auth.uid()) as "ุจุฑูุฏู",
    (SELECT name FROM public.admins WHERE id = auth.uid()) as "ุงุณูู";

-- ============================================

-- 3๏ธโฃ ูู ุฏุงูุฉ is_admin() ุชุนููุ
SELECT 
    '3๏ธโฃ ุงุฎุชุจุงุฑ ุฏุงูุฉ is_admin()' as "ุงูุงุฎุชุจุงุฑ",
    public.is_admin() as "ุงููุชูุฌุฉ",
    CASE 
        WHEN public.is_admin() = true THEN 'โ ุฃูุช ุฃุฏูู'
        WHEN public.is_admin() = false THEN 'โ ูุณุช ุฃุฏูู!'
        ELSE 'โ๏ธ ุฎุทุฃ ูู ุงูุฏุงูุฉ'
    END as "ุงูุญุงูุฉ";

-- ============================================

-- 4๏ธโฃ ูุง ูู ุงูุณูุงุณุงุช ุงููุทุจูุฉ ุนูู ุฌุฏูู hospitalsุ
SELECT 
    '4๏ธโฃ ุณูุงุณุงุช RLS ุนูู hospitals' as "ุงููุนูููุฉ",
    policyname as "ุงุณู ุงูุณูุงุณุฉ",
    cmd as "ููุน ุงูุนูููุฉ",
    roles as "ุงูุฃุฏูุงุฑ ุงููุณููุญุฉ"
FROM pg_policies
WHERE schemaname = 'public' 
  AND tablename = 'hospitals'
ORDER BY cmd;

-- ============================================

-- 5๏ธโฃ ูู RLS ููุนูู ุนูู ุฌุฏูู hospitalsุ
SELECT 
    '5๏ธโฃ ุญุงูุฉ RLS' as "ุงููุนูููุฉ",
    tablename as "ุงูุฌุฏูู",
    rowsecurity as "RLS ููุนููุ",
    CASE 
        WHEN rowsecurity = true THEN 'โ ููุนูู'
        ELSE 'โ ุบูุฑ ููุนูู'
    END as "ุงูุญุงูุฉ"
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename = 'hospitals';

-- ============================================

-- 6๏ธโฃ ุนุฑุถ ุฌููุน ุงูุฃุฏูู ุงููุณุฌููู
SELECT 
    '6๏ธโฃ ูุงุฆูุฉ ุงูุฃุฏูู' as "ุงููุนูููุฉ",
    id as "ุงููุนุฑู",
    name as "ุงูุงุณู",
    email as "ุงูุจุฑูุฏ",
    is_active as "ูุดุทุ",
    CASE 
        WHEN id = auth.uid() THEN '๐ ูุฐุง ุฃูุช'
        ELSE ''
    END as "ููุงุญุธุฉ"
FROM public.admins
ORDER BY created_at DESC;

-- ============================================
-- ุงูุชุดุฎูุต ุงูุชููุงุฆู
-- ============================================

SELECT 
    '๐ ุงูุชุดุฎูุต ุงูุชููุงุฆู' as "ุงููุชูุฌุฉ",
    CASE 
        -- ุงูุญุงูุฉ 1: ูุณุช ูุณุฌู ุฏุฎูู
        WHEN auth.uid() IS NULL THEN 
            'โ ุฃูุช ุบูุฑ ูุณุฌู ุฏุฎูู! ุณุฌู ุฏุฎูู ุฃููุงู.'
        
        -- ุงูุญุงูุฉ 2: ูุณุฌู ุฏุฎูู ููู ูุณุช ุฃุฏูู
        WHEN NOT EXISTS (SELECT 1 FROM public.admins WHERE id = auth.uid()) THEN 
            'โ ุฃูุช ูุณุฌู ุฏุฎูู ููู ูุณุช ุฃุฏูู! ุงุณุชุฎุฏู ุญุณุงุจ ุฃุฏูู.'
        
        -- ุงูุญุงูุฉ 3: ุฃูุช ุฃุฏูู ููู ุงูุฏุงูุฉ ูุง ุชุนูู
        WHEN public.is_admin() IS NULL OR public.is_admin() = false THEN 
            'โ๏ธ ุฃูุช ุฃุฏูู ููู ุฏุงูุฉ is_admin() ูุง ุชุนูู! ูููุฐ COMPLETE_FIX.sql'
        
        -- ุงูุญุงูุฉ 4: ูู ุดูุก ุชูุงู
        WHEN public.is_admin() = true THEN 
            'โ ุฃูุช ุฃุฏูู ููู ุดูุก ุชูุงู! ุงููุดููุฉ ูู ุงูุณูุงุณุฉ. ูููุฐ FORCE_FIX.sql'
        
        ELSE 'โ๏ธ ุญุงูุฉ ุบูุฑ ูุนุฑููุฉ'
    END as "ุงูุชุดุฎูุต ูุงูุญู";

