# ๐ง ุญู ุฎุทุฃ 42501 - Insufficient Privileges

## โ ุงููุดููุฉ

```
Error: code: 42501
ูุดู ุฅุถุงูุฉ ุงููุณุชุดูู
```

**ูุง ุญุฏุซ:**
- โ ุงููุณุชุฎุฏู ุชู ุฅูุดุงุคู ูู `auth.users`
- โ ูุดู ุงูุฅุฏุฑุงุฌ ูู ุฌุฏูู `hospitals`
- ๐ ุงูุณุจุจ: ุณูุงุณุงุช RLS ูุง ุชุณูุญ ููุฃุฏูู ุจุงูุฅุถุงูุฉ

---

## โก ุงูุญู ุงูุณุฑูุน (ุฏูููุฉ ูุงุญุฏุฉ!)

### 1๏ธโฃ ุงูุชุญ Supabase SQL Editor

```
Supabase Dashboard > SQL Editor > New Query
```

### 2๏ธโฃ ูููุฐ ูุฐุง ุงูููุฏ:

```sql
-- ุฅูุดุงุก/ุชุญุฏูุซ ุฏุงูุฉ is_admin
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN EXISTS (SELECT 1 FROM public.admins WHERE id = auth.uid());
END;
$$;

-- ุญุฐู ุงูุณูุงุณุฉ ุงููุฏููุฉ
DROP POLICY IF EXISTS "Enable insert for admins only" ON public.hospitals;

-- ุฅูุดุงุก ุณูุงุณุฉ ุฌุฏูุฏุฉ
CREATE POLICY "Enable insert for admins only"
ON public.hospitals
FOR INSERT
TO authenticated
WITH CHECK (public.is_admin());
```

### 3๏ธโฃ ุงุถุบุท "Run" ุฃู F5

### 4๏ธโฃ โ ุงุฑุฌุน ููุชุทุจูู ูุฌุฑุจ!

---

## ๐ฆ ุงูุณูุฑูุจุชุงุช ุงูุฌุงูุฒุฉ

### 1. `COMPLETE_FIX.sql` โญ (ููุตู ุจู)
**ุงูุญู ุงููุงูู ุงูุดุงูู:**
- โ ุฅูุดุงุก ุฏูุงู is_admin() ู is_hospital()
- โ ุฅุตูุงุญ ุฌููุน ุณูุงุณุงุช RLS
- โ ุงุฎุชุจุงุฑ ุงูุฅุนุฏุงุฏุงุช

**ุงุณุชุฎุฏูู:** ูููุฐู ูุฑุฉ ูุงุญุฏุฉ ูุณุชุญู ูู ุงููุดุงูู!

---

### 2. `simple_users_check.sql` 
**ูุนุฑุถ ุงููุณุชุฎุฏููู:**
- ุนุฑุถ Auth Users
- ุนุฑุถ Hospitals
- ุนุฑุถ Admins
- ุนุฑุถ ุงููุณุชุฎุฏููู ุงููุชุงูู
- ุฅุญุตุงุฆูุงุช

**ุงุณุชุฎุฏูู:** ููุญุต ุงูุจูุงูุงุช ุจุณุฑุนุฉ

---

### 3. `cleanup_orphaned_users.sql`
**ูุชูุธูู ุงููุณุชุฎุฏููู ุงููุชุงูู:**
- ุนุฑุถ ุงููุณุชุฎุฏููู ูู auth ููู ููุณ ูู ุงูุฌุฏุงูู
- ุฎูุงุฑ ุญุฐู ุขูู

**ุงุณุชุฎุฏูู:** ุจุนุฏ ุญู ุงููุดููุฉ ููุชูุธูู

---

### 4. `get_tables_info.sql`
**ูุนูููุงุช ุชูููุฉ:**
- ุชุตููู ุงูุฌุฏุงูู
- ุงูุฃุนูุฏุฉ ูุฃููุงุน ุงูุจูุงูุงุช
- ุณูุงุณุงุช RLS

**ุงุณุชุฎุฏูู:** ููุชุญููู ุงูุนููู

---

### 5. `get_users_data.sql` โ (ูุตููุญ)
**ุจูุงูุงุช ูุงููุฉ:**
- ุฌููุน ุงููุณุชุฎุฏููู ูุน ุชูุงุตูู
- ุงูุนูุงูุงุช ุจูู ุงูุฌุฏุงูู
- (ุชู ุฅุตูุงุญ ูุดููุฉ full_name)

---

## ๐ฏ ุงูุฎุทูุงุช ุงูููุตู ุจูุง

### ุชุฑุชูุจ ุงูุชูููุฐ:

#### 1. **ุญู ุงููุดููุฉ** (ุงูุขู!)
```bash
ูููุฐ: COMPLETE_FIX.sql
```

#### 2. **ูุญุต ุงูุจูุงูุงุช**
```bash
ูููุฐ: simple_users_check.sql
```

#### 3. **ุงุฎุชุจุงุฑ ุงูุชุทุจูู**
- ุณุฌู ุฏุฎูู ูุฃุฏูู
- ุฌุฑุจ ุฅุถุงูุฉ ูุณุชุดูู
- ูุฌุจ ุฃู ูุนูู โ

#### 4. **ุชูุธูู (ุงุฎุชูุงุฑู)**
```bash
ูููุฐ: cleanup_orphaned_users.sql
(ูุญุฐู ุงููุณุชุฎุฏููู ุงููุชุงูู ูู ุงููุญุงููุงุช ุงููุงุดูุฉ)
```

---

## ๐ ุงูุชุญูู ูู ูุฌุงุญ ุงูุญู

ุจุนุฏ ุชูููุฐ `COMPLETE_FIX.sql`ุ ูููุฐ:

```sql
-- ูุฌุจ ุฃู ูุนูุฏ true ุฅุฐุง ููุช ุฃุฏูู
SELECT public.is_admin();

-- ูุฌุจ ุฃู ูุนุฑุถ 4 ุณูุงุณุงุช
SELECT policyname, cmd 
FROM pg_policies 
WHERE tablename = 'hospitals';
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ Enable read access for all users (SELECT)
- โ Enable insert for admins only (INSERT)
- โ Enable update for admins and own hospital (UPDATE)
- โ Enable delete for admins only (DELETE)

---

## ๐ ููู ุงููุดููุฉ

### ุงูุณููุงุฑูู:

```
1. ุงูุฃุฏูู ูุญุงูู ุฅุถุงูุฉ ูุณุชุดูู
   โ
2. ุงูุชุทุจูู ููุดุฆ user ูู auth.users โ
   โ
3. ุงูุชุทุจูู ูุญุงูู ุงูุฅุฏุฑุงุฌ ูู hospitals โ
   โ
4. RLS Policy ูููุน ุงูุนูููุฉ
   โ
5. ุฎุทุฃ 42501 (insufficient privileges)
```

### ุงูุญู:

```sql
-- ุงูุณูุงุณุฉ ุงููุฏููุฉ: ูู ุชูู ุชุณูุญ ููุฃุฏูู
-- ุงูุณูุงุณุฉ ุงูุฌุฏูุฏุฉ:
WITH CHECK (public.is_admin())
-- โ ุชุณูุญ ููุฃุฏูู ุจุงูุฅุถุงูุฉ โ
```

---

## โ๏ธ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### ุชุญูู ูู:

#### 1. ูู ุฃูุช ูุณุฌู ูุฃุฏููุ
```sql
SELECT * FROM public.admins WHERE id = auth.uid();
```
ูุฌุจ ุฃู ููุฑุฌุน ุณุฌูู!

#### 2. ูู RLS ููุนููุ
```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE tablename = 'hospitals';
```
ูุฌุจ ุฃู ูููู `true`

#### 3. ูู ุงูุณูุงุณุงุช ุตุญูุญุฉุ
```sql
SELECT * FROM pg_policies WHERE tablename = 'hospitals';
```
ูุฌุจ ุฃู ุชุฑู 4 ุณูุงุณุงุช

---

## ๐ก ููุงุญุธุงุช ูููุฉ

### โ ุจุนุฏ ุงูุญู:
- ุงูุฃุฏูู ููููู ุฅุถุงูุฉ ูุณุชุดููุงุช
- ุงูุฃุฏูู ููููู ุชุนุฏูู ูุญุฐู ุงููุณุชุดููุงุช
- ุงููุณุชุดูู ููููู ุชุนุฏูู ุจูุงูุงุชู ููุท
- ุงูุฌููุน ูููููู ุงููุฑุงุกุฉ

### โ๏ธ ุชูุจููุงุช:
- ุงููุณุชุฎุฏููู "ุงููุชุงูู" ูู ูุคุซุฑูุง ุนูู ุงูุชุทุจูู
- ูููู ุญุฐููู ูุงุญูุงู ููุชูุธูู
- ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู ูุฃุฏูู ูุจู ุงูุงุฎุชุจุงุฑ

---

## ๐ ุงุจุฏุฃ ุงูุขู!

```bash
1. ุงูุชุญ Supabase SQL Editor
2. ูููุฐ COMPLETE_FIX.sql
3. ุงุฑุฌุน ููุชุทุจูู
4. ุฌุฑุจ ุฅุถุงูุฉ ูุณุชุดูู
5. โ ุงููุฌุงุญ!
```

---

**ุฌุงูุฒุ ูููุฐ `COMPLETE_FIX.sql` ูุฃุฎุจุฑูู ุจุงููุชูุฌุฉ!** ๐ฏ

